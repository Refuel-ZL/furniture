<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>
        <%- title %>
    </title>
    <style>
        #table thead {
            background-color: rgba(60, 48, 48, 0.5)
        }
    </style>
</head>

<body>
    <%- include("../header.ejs") %>
        <%- include("../static/bootstrap-table.ejs") %>
            <%- include("../static/bootstrap3-typeahead.ejs") %>
                <div class="container">
                    <div id="toolbar" class="btn-group">
                        <div class="row">
                            <div class="col-xs-6 col-sm-4">
                                <input type="text" class="form-control" autocomplete="off" id="wd" aria-label="请输入产品编号" placeholder="产品编号">
                            </div>
                            <div class="col-xs-4 col-sm-2">
                                <button type="button" class="btn btn-default" id="search">查询</button>
                            </div>
                            <div class="col-xs-6 col-sm-4">
                                <select class="form-control">
                                    <option value="basic">导出当前</option>
                                    <option value="all">导出所有</option>
                                    <!-- <option value="selected">导出选中</option> //服务器分页暂不处理-->
                                 </select>
                            </div>
                        </div>
                    </div>
                    <table id="table"></table>
                </div>
                <%- include("../footer.ejs") %>

                    <script>
                        $(function() {
                            var ID = $.getUrlParam('pid');
                            $("#table").bootstrapTable(
                                TableInit.table
                            );
                            if (ID) {
                                $("#wd").val(ID)
                                $("#search").click()
                            }
                            $("#wd").keydown(function(event) {
                                if (event.keyCode == 13) {
                                    // $("#search").click()
                                }
                            })
                            $("#wd").typeahead({
                                delay: 500,
                                fitToElement: true,
                                source: function(query, process) {
                                    return $.ajax({
                                        url: '/order/pidlist',
                                        type: 'post',
                                        data: {
                                            name: query
                                        },
                                        success: function(result) {
                                            for (var i = 0; i < result.length; i++) {
                                                result[i] = JSON.stringify(result[i])
                                            }
                                            return process(result);
                                        }

                                    })
                                },
                                highlighter: function(obj) {
                                    var item = JSON.parse(obj);
                                    var query = this.query.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g, '\\$&');
                                    return item.pid.replace(new RegExp('(' + query + ')', 'ig'), function($1, match) {
                                        return '<strong>' + match + '</strong>'
                                    });
                                },
                                updater: function(obj) {
                                    var item = JSON.parse(obj);
                                    return item.pid;
                                },
                                afterSelect: function() {
                                    $("#search").click()
                                }
                            })

                            $('#toolbar').find('select').change(function() {
                                $("#table").bootstrapTable('refreshOptions', {
                                    exportDataType: $(this).val()
                                });
                            });

                        })

                        $("#search").click(function() {
                            var val = $("#wd").val()
                            if (val == "") return
                            $("#table").bootstrapTable('refreshOptions', {
                                url: '/order/pid_data?pid=' + val,
                                method: 'get',
                                exportOptions: {
                                    fileName: val
                                }
                            });
                        })

                        var TableInit = {
                            table: {
                                toolbar: '#toolbar', //工具按钮用哪个容器
                                singleSelect: true, //多选
                                striped: true, //是否显示行间隔色
                                cache: false, //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
                                pagination: true, //是否显示分页（*）
                                sortable: true, //是否启用排序
                                sortName: 'index',
                                sortOrder: 'asc', //排序方式
                                queryParams: function(params) {
                                    var temp = { //这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的
                                        limit: params.limit, //页面大小
                                        offset: params.offset, //页码
                                        sortOrder: params.order,
                                        sortName: params.sort, //排序字段(仅支持序号index)
                                        search: params.search
                                    }
                                    return temp
                                }, //传递参数（*）
                                sidePagination: 'server', //分页方式：client客户端分页，server服务端分页（*）
                                pageNumber: 1, //初始化加载第一页，默认第一页
                                pageSize: 10, //每页的记录行数（*）
                                pageList: [10, 25, 50, 100], //可供选择的每页的行数（*）
                                search: true, //是否显示表格搜索
                                // strictSearch: false,
                                showColumns: true, //是否显示所有的列
                                showRefresh: true, //是否显示刷新按钮
                                minimumCountColumns: 2, //最少允许的列数
                                clickToSelect: true, //是否启用点击选中行
                                // height: 800, //行高，如果没有设置height属性，表格自动根据记录条数觉得表格高度
                                // uniqueId: 'ID', //每一行的唯一标识，一般为主键列
                                showToggle: true, //是否显示详细视图和列表视图的切换按钮
                                cardView: false, //是否显示详细视图
                                detailView: false, //是否显示父子表
                                showExport: true, //是否显示导出
                                exportDataType: 'selected', //basic'//当前页, 'all'//所有, 'selected'.//选择项
                                // 'json', 'xml', 'png', 'csv', 'txt', 'sql', 'doc', 'excel', 'xlsx', 'pdf'.
                                exportTypes: ['txt', 'doc', 'excel'],
                                exportOptions: {
                                    fileName: '文件名',
                                },
                                columns: [{
                                    field: 'pid',
                                    title: '编号',
                                }, {
                                    field: 'regtime',
                                    title: '录入时间',
                                }, {
                                    field: 'category',
                                    title: '类别'
                                }, {
                                    field: 'status',
                                    title: '状态'
                                }, {
                                    field: 'index',
                                    title: '序号'
                                }, {
                                    field: 'workstage',
                                    title: '工序'
                                }, {
                                    field: 'userid',
                                    title: '员工'
                                }, {
                                    field: 'recordtime',
                                    title: '操作时间'
                                }, {
                                    field: 'kind',
                                    title: '操作类别',
                                    formatter: function indexFormatter(value, row, index) { //在表格前加上序号
                                        if (value == 0) {
                                            return '<span style="color:#000000">默认</span>';
                                        } else if (value == 1) {
                                            return '<span style="color:#00ff00">临时</span>';
                                        }

                                    }

                                }]
                            }
                        }
                    </script>

                    <script>
                        /***
                         * 获取url所带参数
                         * */
                        (function($) {
                            $.getUrlParam = function(name) {
                                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
                                var r = window.location.search.substr(1).match(reg);
                                if (r != null) return decodeURIComponent(r[2]);
                                return null;
                            }
                        })(jQuery);
                    </script>
</body>

</html>